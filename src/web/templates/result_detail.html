{% extends "layout.html" %}

{% block title %}NetScout-Pi - Result Detail{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('results') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Results
            </a>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0" id="result-title">
                <i class="fas fa-clipboard-check me-2"></i>
                <span id="plugin-name">Result Details</span>
            </h4>
            <span id="result-time" class="badge bg-light text-dark"></span>
        </div>
        <div class="card-body">
            <div id="result-container">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading result details...</p>
                </div>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between">
            <span id="result-metadata" class="text-muted"></span>
            <div>
                <button id="btn-rerun" class="btn btn-sm btn-primary">
                    <i class="fas fa-redo me-1"></i> Run Again
                </button>
                <button id="btn-export" class="btn btn-sm btn-outline-secondary ms-2">
                    <i class="fas fa-download me-1"></i> Export
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        const runId = '{{ run_id }}';
        
        // Load result details
        loadResultDetail(runId);
        
        // Rerun button
        $('#btn-rerun').click(function() {
            rerunPlugin();
        });
        
        // Export button
        $('#btn-export').click(function() {
            exportResult(runId);
        });
        
        function loadResultDetail(runId) {
            $('#result-container').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading result details...</p>
                </div>
            `);
            
            // Fetch result from API
            $.getJSON(`/api/results/${runId}`, function(data) {
                if (!data || !data.result) {
                    $('#result-container').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Result not found or invalid.
                        </div>
                    `);
                    return;
                }
                
                // Update header info
                $('#plugin-name').text(data.plugin_name || 'Unknown Plugin');
                
                if (data.timestamp) {
                    const date = new Date(data.timestamp);
                    $('#result-time').text(date.toLocaleString());
                }
                
                let metadataText = '';
                if (data.interface) metadataText += `Interface: ${data.interface} | `;
                if (data.duration) metadataText += `Duration: ${data.duration.toFixed(2)}s | `;
                if (data.user) metadataText += `Run by: ${data.user} | `;
                $('#result-metadata').text(metadataText.replace(/\|\s$/, ''));
                
                // Store plugin name for rerun
                $('#btn-rerun').data('plugin', data.plugin_name);
                
                // Format result based on plugin type
                let resultHtml = '';
                
                if (data.error) {
                    resultHtml += `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error:</strong> ${data.error}
                        </div>
                    `;
                }
                
                // Determine result format based on plugin name
                if (data.plugin_name === 'ip_info') {
                    resultHtml += formatIpInfoResult(data.result);
                } else if (data.plugin_name === 'ping_test') {
                    resultHtml += formatPingTestResult(data.result);
                } else if (data.plugin_name === 'port_scan') {
                    resultHtml += formatPortScanResult(data.result);
                } else if (data.plugin_name === 'arp_scan') {
                    resultHtml += formatArpScanResult(data.result);
                } else if (data.plugin_name === 'speed_test') {
                    resultHtml += formatSpeedTestResult(data.result);
                } else if (data.plugin_name === 'traceroute') {
                    resultHtml += formatTracerouteResult(data.result);
                } else {
                    // Generic format for other plugins
                    resultHtml += `
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Raw Result Data</h5>
                            </div>
                            <div class="card-body">
                                <pre class="bg-light p-3 rounded">${JSON.stringify(data.result, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }
                
                $('#result-container').html(resultHtml);
            }).fail(function() {
                $('#result-container').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load result. Please try again later.
                    </div>
                `);
            });
        }
        
        function rerunPlugin() {
            const pluginName = $('#btn-rerun').data('plugin');
            if (!pluginName) {
                alert('Cannot determine plugin to run');
                return;
            }
            
            $('#btn-rerun').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Running...');
            
            // Call API to run plugin
            $.ajax({
                url: `/api/plugin/${pluginName}/run`,
                type: 'POST',
                success: function(data) {
                    if (data && data.status === 'running') {
                        alert(`${pluginName} is running. Check results page for updates.`);
                    }
                },
                error: function() {
                    alert('Failed to run plugin. Please try again.');
                },
                complete: function() {
                    $('#btn-rerun').prop('disabled', false).html('<i class="fas fa-redo me-1"></i> Run Again');
                }
            });
        }
        
        function exportResult(runId) {
            window.location.href = `/api/results/${runId}/export`;
        }
        
        // Placeholder formatting functions - these would be implemented based on your plugin output format
        function formatIpInfoResult(result) {
            let html = '<div class="card mb-3"><div class="card-body">';
            
            if (result.status === 'down') {
                html += `
                    <div class="alert alert-warning">
                        Interface ${result.interface} is down
                    </div>
                `;
                html += '</div></div>';
                return html;
            }
            
            html += `
                <h5>IP Information for ${result.interface || 'Unknown Interface'}</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tbody>
            `;
            
            // IP Addresses
            if (result.addresses && result.addresses.ipv4) {
                const ipv4 = result.addresses.ipv4;
                html += `
                    <tr>
                        <th>IPv4 Address</th>
                        <td>${ipv4.address || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Subnet Mask</th>
                        <td>${ipv4.netmask || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Network</th>
                        <td>${ipv4.network || 'N/A'}</td>
                    </tr>
                `;
            }
            
            // Other network info
            html += `
                <tr>
                    <th>MAC Address</th>
                    <td>${result.mac_address || 'N/A'}</td>
                </tr>
                <tr>
                    <th>Gateway</th>
                    <td>${result.gateway || 'N/A'}</td>
                </tr>
                <tr>
                    <th>Hostname</th>
                    <td>${result.hostname || 'N/A'}</td>
                </tr>
            `;
            
            // DNS Servers
            if (result.dns_servers && result.dns_servers.length > 0) {
                html += `
                    <tr>
                        <th>DNS Servers</th>
                        <td>${result.dns_servers.join('<br>')}</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            html += '</div></div>';
            return html;
        }
        
        function formatPingTestResult(result) {
            // Implementation for ping test results
            return '<div class="alert alert-info">Ping test result formatting not implemented</div>';
        }
        
        function formatPortScanResult(result) {
            // Implementation for port scan results
            return '<div class="alert alert-info">Port scan result formatting not implemented</div>';
        }
        
        function formatArpScanResult(result) {
            // Implementation for ARP scan results
            return '<div class="alert alert-info">ARP scan result formatting not implemented</div>';
        }
        
        function formatSpeedTestResult(result) {
            // Implementation for speed test results
            return '<div class="alert alert-info">Speed test result formatting not implemented</div>';
        }
        
        function formatTracerouteResult(result) {
            // Implementation for traceroute results
            return '<div class="alert alert-info">Traceroute result formatting not implemented</div>';
        }
    });
</script>
{% endblock %}
