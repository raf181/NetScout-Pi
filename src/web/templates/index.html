{% extends "layout.html" %}

{% block title %}NetProbe Pi - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired me-2"></i>Network Status
                </h5>
            </div>
            <div class="card-body">
                <div id="network-info">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading network information...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button id="refresh-network" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-sync-alt me-1"></i> Refresh
                </button>
                <button id="run-ip-info" class="btn btn-sm btn-primary float-end">
                    <i class="fas fa-play me-1"></i> Run IP Info
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <button id="run-ping" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-exchange-alt me-2"></i>Ping Test</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                    <button id="run-speed" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tachometer-alt me-2"></i>Speed Test</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                    <button id="run-arp" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-search me-2"></i>ARP Scan</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('plugins') }}" class="btn btn-sm btn-success">
                    <i class="fas fa-plug me-1"></i> All Plugins
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Results
                </h5>
            </div>
            <div class="card-body">
                <div id="recent-results">
                    <div class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading results...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('results') }}" class="btn btn-sm btn-info text-white">
                    <i class="fas fa-clipboard-list me-1"></i> All Results
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Network Activity
                </h5>
            </div>
            <div class="card-body">
                <div id="network-chart" style="height: 300px;">
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Network activity chart will be displayed here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>System Status
                </h5>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <div class="text-center py-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading system status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for displaying results -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Plugin Result</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="result-content">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Running plugin...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    $(document).ready(function() {
        // Initialize Socket.IO
        const socket = io();

        // Load initial data
        loadNetworkInfo();
        loadRecentResults();
        loadSystemStatus();

        // Setup event handlers
        $('#refresh-network').click(loadNetworkInfo);
        $('#run-ip-info').click(() => runPlugin('ip_info'));
        $('#run-ping').click(() => runPlugin('ping_test'));
        $('#run-speed').click(() => runPlugin('speed_test'));
        $('#run-arp').click(() => runPlugin('arp_scan'));

        // Socket.IO event handlers
        socket.on('connect', function() {
            console.log('Socket.IO connected');
        });
        
        socket.on('disconnect', function() {
            console.log('Socket.IO disconnected');
        });
        
        socket.on('plugin_result', function(data) {
            console.log('Plugin result received:', data);
            displayPluginResult(data);
            loadRecentResults();
        });

        socket.on('plugin_progress', function(data) {
            console.log('Plugin progress:', data);
            updatePluginProgress(data);
        });

        socket.on('network_event', function(data) {
            console.log('Network event:', data);
            if (data.event === 'eth_connect') {
                $('#network-status').html('<i class="fas fa-circle text-success me-1"></i> Connected');
                loadNetworkInfo();
            } else if (data.event === 'eth_disconnect') {
                $('#network-status').html('<i class="fas fa-circle text-danger me-1"></i> Disconnected');
                loadNetworkInfo();
            }
        });
        
        // Global listener for all plugin results
        const pluginNames = ['ip_info', 'ping_test', 'arp_scan', 'speed_test', 'port_scan', 'traceroute', 'vlan_detector'];
        pluginNames.forEach(pluginName => {
            socket.on(`plugin_result_${pluginName}`, function(result) {
                console.log(`${pluginName} result received:`, result);
                displayPluginResult({
                    plugin_name: pluginName,
                    result: result
                });
                loadRecentResults();
            });
        });

        // Functions
        function loadNetworkInfo() {
            $('#network-info').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading network information...</p>
                </div>
            `);

            $.getJSON('/api/network/status', function(data) {
                let html = '';
                
                // Show primary interface info
                const primaryInterface = data.primary_interface || 'eth0';
                const ifData = data[primaryInterface];
                
                if (ifData) {
                    const statusColor = ifData.carrier ? 'success' : 'danger';
                    const statusText = ifData.carrier ? 'Connected' : 'Disconnected';
                    
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Interface ${primaryInterface}</h6>
                            <span class="badge bg-${statusColor}">${statusText}</span>
                        </div>
                    `;
                    
                    if (ifData.addresses && ifData.addresses.ipv4) {
                        html += `
                            <div class="mb-2">
                                <small class="text-muted d-block">IPv4 Address</small>
                                <strong>${ifData.addresses.ipv4.addr || 'Not available'}</strong>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted d-block">Subnet Mask</small>
                                <strong>${ifData.addresses.ipv4.netmask || 'Not available'}</strong>
                            </div>
                        `;
                    }
                    
                    if (ifData.addresses && ifData.addresses.mac) {
                        html += `
                            <div class="mb-2">
                                <small class="text-muted d-block">MAC Address</small>
                                <strong>${ifData.addresses.mac || 'Not available'}</strong>
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No information available for ${primaryInterface}
                        </div>
                    `;
                }

                // Show Wi-Fi interface info if available
                const wifiInterface = data.wifi_interface || 'wlan0';
                if (data[wifiInterface] && wifiInterface !== primaryInterface) {
                    const wifiData = data[wifiInterface];
                    const wifiStatusColor = wifiData.carrier ? 'success' : 'danger';
                    const wifiStatusText = wifiData.carrier ? 'Connected' : 'Disconnected';
                    
                    html += `
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">WiFi (${wifiInterface})</h6>
                            <span class="badge bg-${wifiStatusColor}">${wifiStatusText}</span>
                        </div>
                    `;
                    
                    if (wifiData.addresses && wifiData.addresses.ipv4) {
                        html += `
                            <div class="mb-2">
                                <small class="text-muted d-block">IPv4 Address</small>
                                <strong>${wifiData.addresses.ipv4.addr || 'Not available'}</strong>
                            </div>
                        `;
                    }
                }
                
                // Add internet status
                if (data.internet_status) {
                    const internetStatusColor = data.internet_status === 'connected' ? 'success' : 'danger';
                    const internetStatusText = data.internet_status === 'connected' ? 'Connected' : 'Disconnected';
                    
                    html += `
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Internet</h6>
                            <span class="badge bg-${internetStatusColor}">${internetStatusText}</span>
                        </div>
                    `;
                }
                
                // Add DNS servers if available
                if (data.dns_servers && data.dns_servers.length > 0) {
                    html += `
                        <div class="mb-2">
                            <small class="text-muted d-block">DNS Servers</small>
                            <strong>${data.dns_servers.join(', ')}</strong>
                        </div>
                    `;
                }
                
                // Add gateway if available
                if (data.default_gateway) {
                    html += `
                        <div class="mb-2">
                            <small class="text-muted d-block">Default Gateway</small>
                            <strong>${data.default_gateway}</strong>
                        </div>
                    `;
                }

                $('#network-info').html(html);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error loading network info:", textStatus, errorThrown);
                $('#network-info').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load network information. 
                        <button id="retry-network" class="btn btn-sm btn-danger mt-2">Retry</button>
                    </div>
                `);
                $('#retry-network').click(loadNetworkInfo);
            });
        }

        function loadRecentResults() {
            $('#recent-results').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-info" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading results...</p>
                </div>
            `);

            $.getJSON('/api/results/recent', function(data) {
                if (!data || data.length === 0) {
                    $('#recent-results').html(`
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            No recent results found. Run a plugin to see results here.
                        </div>
                    `);
                    return;
                }

                let html = '<div class="list-group">';
                
                data.forEach(result => {
                    const time = new Date(result.timestamp).toLocaleTimeString();
                    const pluginName = result.plugin_name || result.plugin?.name || 'Unknown';
                    
                    // Determine status icon
                    let statusIcon = '';
                    if (result.error) {
                        statusIcon = '<i class="fas fa-exclamation-circle text-danger me-2"></i>';
                    } else if (result.success === false) {
                        statusIcon = '<i class="fas fa-times-circle text-warning me-2"></i>';
                    } else {
                        statusIcon = '<i class="fas fa-check-circle text-success me-2"></i>';
                    }
                    
                    html += `
                        <a href="/results/${result.run_id}" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${statusIcon}${pluginName}</h6>
                                <small>${time}</small>
                            </div>
                            <p class="mb-1">${result.summary || 'No summary available'}</p>
                        </a>
                    `;
                });
                
                html += '</div>';
                $('#recent-results').html(html);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error loading recent results:", textStatus, errorThrown);
                $('#recent-results').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load recent results.
                        <button id="retry-results" class="btn btn-sm btn-danger mt-2">Retry</button>
                    </div>
                `);
                $('#retry-results').click(loadRecentResults);
            });
        }

        function loadSystemStatus() {
            $('#system-status').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading system status...</p>
                </div>
            `);

            $.getJSON('/api/system/status', function(data) {
                let html = '';
                
                // CPU usage
                const cpuUsageClass = data.cpu_percent < 50 ? 'success' : 
                                    data.cpu_percent < 80 ? 'warning' : 'danger';
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>CPU Usage</span>
                            <span class="text-${cpuUsageClass}" id="cpu-usage">${data.cpu_percent.toFixed(1)}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="cpu-progress" class="progress-bar bg-${cpuUsageClass}" role="progressbar" 
                                style="width: ${data.cpu_percent}%;" aria-valuenow="${data.cpu_percent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;

                // Memory usage
                const memoryUsageClass = data.memory_percent < 50 ? 'success' : 
                                      data.memory_percent < 80 ? 'warning' : 'danger';
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Memory Usage</span>
                            <span class="text-${memoryUsageClass}" id="memory-usage">${data.memory_percent.toFixed(1)}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="memory-progress" class="progress-bar bg-${memoryUsageClass}" role="progressbar" 
                                style="width: ${data.memory_percent}%;" aria-valuenow="${data.memory_percent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;

                // Disk usage
                const diskUsageClass = data.disk_percent < 70 ? 'success' : 
                                     data.disk_percent < 90 ? 'warning' : 'danger';
                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Disk Usage</span>
                            <span class="text-${diskUsageClass}" id="disk-usage">${data.disk_percent.toFixed(1)}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="disk-progress" class="progress-bar bg-${diskUsageClass}" role="progressbar" 
                                style="width: ${data.disk_percent}%;" aria-valuenow="${data.disk_percent}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;

                // Temperature
                if (data.temperature) {
                    const tempClass = data.temperature < 65 ? 'success' : 
                                    data.temperature < 75 ? 'warning' : 'danger';
                    html += `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Temperature</span>
                                <span class="text-${tempClass}" id="temperature">${data.temperature.toFixed(1)}°C</span>
                            </div>
                        </div>
                    `;
                }

                // Uptime
                html += `
                    <div class="mb-1">
                        <div class="d-flex justify-content-between">
                            <span>Uptime</span>
                            <span>${formatUptime(data.uptime)}</span>
                        </div>
                    </div>
                `;
                
                $('#system-status').html(html);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error loading system status:", textStatus, errorThrown);
                $('#system-status').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load system status.
                        <button id="retry-system" class="btn btn-sm btn-danger mt-2">Retry</button>
                    </div>
                `);
                $('#retry-system').click(loadSystemStatus);
            });
        }

        function runPlugin(pluginName) {
            // Show the modal
            const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
            resultModal.show();
            
            $('#result-content').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Running ${pluginName}...</p>
                    <div class="progress mt-3">
                        <div id="plugin-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                            role="progressbar" style="width: 0%" aria-valuenow="0" 
                            aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            `);

            // Call API to run plugin
            $.ajax({
                url: `/api/plugin/${pluginName}/run`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),  // No parameters for now
                success: function(data) {
                    // Wait for Socket.IO to deliver the result
                    console.log(`Plugin ${pluginName} is running...`);
                    
                    // Listen for the specific plugin result event
                    socket.on(`plugin_result_${pluginName}`, function(result) {
                        displayPluginResult({
                            plugin_name: pluginName,
                            result: result
                        });
                        
                        // Refresh data after plugin completes
                        loadNetworkInfo();
                        loadRecentResults();
                    });
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    $('#result-content').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error running plugin: ${textStatus}
                            <p class="small mt-1 mb-0">${errorThrown}</p>
                        </div>
                    `);
                }
            });
        }

        function displayPluginResult(data) {
            if (!data || !data.result) {
                $('#result-content').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        No result data available.
                    </div>
                `);
                return;
            }

            const pluginName = data.plugin_name || 'Unknown';
            const result = data.result;
            let html = '';
            
            // Set modal title
            $('.modal-title').text(`${pluginName} Result`);
            
            // Display error if any
            if (result.error) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${result.error}
                    </div>
                `;
            }

            // Format result based on plugin type
            if (pluginName === 'ip_info') {
                html += formatIpInfoResult(result);
            } else if (pluginName === 'ping_test') {
                html += formatPingTestResult(result);
            } else if (pluginName === 'arp_scan') {
                html += formatArpScanResult(result);
            } else if (pluginName === 'speed_test') {
                html += formatSpeedTestResult(result);
            } else if (pluginName === 'port_scan') {
                html += formatPortScanResult(result);
            } else if (pluginName === 'traceroute') {
                html += formatTracerouteResult(result);
            } else {
                // Generic JSON display
                html += `
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Raw Result Data</h6>
                        </div>
                        <div class="card-body">
                            <pre class="bg-light p-3 rounded mb-0" style="max-height: 400px; overflow-y: auto;">${JSON.stringify(result, null, 2)}</pre>
                        </div>
                    </div>
                `;
            }

            $('#result-content').html(html);
        }

        function formatIpInfoResult(result) {
            let html = '';
            
            if (result.status === 'down') {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Interface ${result.interface || 'Unknown'} is down
                    </div>
                `;
                return html;
            }

            html += `
                <h5>IP Information for ${result.interface || 'Unknown Interface'}</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <tbody>`;
            
            // IP Addresses
            if (result.addresses && result.addresses.ipv4) {
                const ipv4 = result.addresses.ipv4;
                html += `
                    <tr>
                        <th>IPv4 Address</th>
                        <td>${ipv4.addr || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Subnet Mask</th>
                        <td>${ipv4.netmask || 'N/A'}</td>
                    </tr>
                    <tr>
                        <th>Broadcast</th>
                        <td>${ipv4.broadcast || 'N/A'}</td>
                    </tr>`;
            }
            
            // MAC Address
            if (result.addresses && result.addresses.mac) {
                html += `
                    <tr>
                        <th>MAC Address</th>
                        <td>${result.addresses.mac}</td>
                    </tr>`;
            } else {
                html += `
                    <tr>
                        <th>MAC Address</th>
                        <td>${result.mac_address || 'N/A'}</td>
                    </tr>`;
            }
            
            // Gateway
            html += `
                <tr>
                    <th>Gateway</th>
                    <td>${result.gateway || 'N/A'}</td>
                </tr>
                <tr>
                    <th>Hostname</th>
                    <td>${result.hostname || 'N/A'}</td>
                </tr>`;
            
            // DNS Servers
            if (result.dns_servers && result.dns_servers.length > 0) {
                html += `
                    <tr>
                        <th>DNS Servers</th>
                        <td>${result.dns_servers.join('<br>')}</td>
                    </tr>`;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>`;
            
            return html;
        }
        
        function formatPingTestResult(result) {
            let html = '';
            
            if (result.error) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error}
                    </div>`;
                return html;
            }

            html += `
                <h5>Ping Test Results</h5>
                <p class="text-muted">Interface: ${result.interface || 'N/A'}</p>`;
                
            if (result.status) {
                const statusClass = result.status === 'excellent' ? 'success' : 
                                    result.status === 'good' ? 'primary' : 
                                    result.status === 'fair' ? 'warning' : 'danger';
                
                html += `
                    <div class="alert alert-${statusClass}">
                        <i class="fas fa-info-circle me-2"></i>
                        Connection Quality: <strong>${result.status.toUpperCase()}</strong>
                    </div>`;
            }
            
            if (result.results && result.results.length > 0) {
                html += `
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Host</th>
                                    <th>Status</th>
                                    <th>Min (ms)</th>
                                    <th>Avg (ms)</th>
                                    <th>Max (ms)</th>
                                    <th>Packet Loss</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                result.results.forEach(ping => {
                    const statusClass = ping.success ? 'success' : 'danger';
                    const statusIcon = ping.success ? 
                        '<i class="fas fa-check-circle text-success"></i>' : 
                        '<i class="fas fa-times-circle text-danger"></i>';
                    
                    html += `
                        <tr>
                            <td>${ping.host}</td>
                            <td>${statusIcon}</td>
                            <td>${ping.min !== undefined ? ping.min.toFixed(2) : 'N/A'}</td>
                            <td>${ping.avg !== undefined ? ping.avg.toFixed(2) : 'N/A'}</td>
                            <td>${ping.max !== undefined ? ping.max.toFixed(2) : 'N/A'}</td>
                            <td>${ping.packet_loss !== undefined ? ping.packet_loss + '%' : 'N/A'}</td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No ping results available
                    </div>`;
            }
            
            return html;
        }
        
        function formatArpScanResult(result) {
            let html = '';
            
            if (result.error) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error}
                    </div>`;
                return html;
            }

            html += `
                <h5>ARP Scan Results</h5>
                <p class="text-muted">Interface: ${result.interface || 'N/A'}, Subnet: ${result.subnet || 'N/A'}</p>`;
            
            if (result.devices && result.devices.length > 0) {
                html += `
                    <p>Found ${result.devices.length} devices on the network</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Vendor</th>
                                    <th>Hostname</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                result.devices.forEach(device => {
                    html += `
                        <tr>
                            <td>${device.ip || 'N/A'}</td>
                            <td>${device.mac || 'N/A'}</td>
                            <td>${device.vendor || 'Unknown'}</td>
                            <td>${device.hostname || 'Unknown'}</td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No devices found on the network
                    </div>`;
            }
            
            return html;
        }
        
        function formatSpeedTestResult(result) {
            let html = '';
            
            if (result.error) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error}
                    </div>`;
                return html;
            }

            html += `
                <h5>Speed Test Results</h5>`;
            
            if (result.download !== undefined && result.upload !== undefined) {
                html += `
                    <div class="row text-center mb-4">
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Download</h6>
                                    <p class="display-6">${(result.download / 1000000).toFixed(2)}</p>
                                    <p class="text-muted">Mbps</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-title">Upload</h6>
                                    <p class="display-6">${(result.upload / 1000000).toFixed(2)}</p>
                                    <p class="text-muted">Mbps</p>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }
            
            if (result.ping !== undefined) {
                html += `
                    <div class="card mb-3">
                        <div class="card-body text-center">
                            <h6 class="card-title">Ping</h6>
                            <p class="h3">${result.ping.toFixed(2)} ms</p>
                        </div>
                    </div>`;
            }
            
            if (result.server_info) {
                html += `
                    <div class="card mb-3">
                        <div class="card-header">Server Information</div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Name:</span>
                                    <span>${result.server_info.name || 'N/A'}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Location:</span>
                                    <span>${result.server_info.location || 'N/A'}</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <span>Host:</span>
                                    <span>${result.server_info.host || 'N/A'}</span>
                                </li>
                            </ul>
                        </div>
                    </div>`;
            }
            
            return html;
        }
        
        function formatPortScanResult(result) {
            let html = '';
            
            if (result.error) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error}
                    </div>`;
                return html;
            }

            html += `
                <h5>Port Scan Results</h5>
                <p class="text-muted">Target: ${result.target || 'N/A'}</p>`;
            
            if (result.open_ports && result.open_ports.length > 0) {
                html += `
                    <p>Found ${result.open_ports.length} open ports</p>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Port</th>
                                    <th>Protocol</th>
                                    <th>Service</th>
                                    <th>State</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                result.open_ports.forEach(port => {
                    html += `
                        <tr>
                            <td>${port.port || 'N/A'}</td>
                            <td>${port.protocol || 'tcp'}</td>
                            <td>${port.service || 'Unknown'}</td>
                            <td><span class="badge bg-success">Open</span></td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No open ports found
                    </div>`;
            }
            
            return html;
        }
        
        function formatTracerouteResult(result) {
            let html = '';
            
            if (result.error) {
                html += `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${result.error}
                    </div>`;
                return html;
            }

            html += `
                <h5>Traceroute Results</h5>
                <p class="text-muted">Target: ${result.target || 'N/A'}</p>`;
            
            if (result.hops && result.hops.length > 0) {
                html += `
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Hop</th>
                                    <th>Host</th>
                                    <th>IP</th>
                                    <th>RTT (ms)</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                result.hops.forEach((hop, index) => {
                    const rtt = hop.rtt ? hop.rtt.toFixed(2) : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${hop.host || 'Unknown'}</td>
                            <td>${hop.ip || '*'}</td>
                            <td>${rtt}</td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>`;
            } else {
                html += `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No traceroute hops found
                    </div>`;
            }
            
            return html;
        }
        
        function formatUptime(seconds) {
            const days = Math.floor(seconds / (24 * 60 * 60));
            seconds %= (24 * 60 * 60);
            const hours = Math.floor(seconds / (60 * 60));
            seconds %= (60 * 60);
            const minutes = Math.floor(seconds / 60);
            
            let result = '';
            if (days > 0) result += `${days}d `;
            if (hours > 0) result += `${hours}h `;
            if (minutes > 0) result += `${minutes}m`;
            
            return result || '< 1m';
        }
        
        function updatePluginProgress(data) {
            if (!data || !data.progress) return;
            
            const progress = parseInt(data.progress);
            $('#plugin-progress-bar')
                .css('width', `${progress}%`)
                .attr('aria-valuenow', progress);
            
            if (data.status === 'error') {
                $('#plugin-progress-bar')
                    .removeClass('progress-bar-animated')
                    .addClass('bg-danger');
            }
        }
    });
</script>
{% endblock %}
