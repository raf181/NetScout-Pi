{% extends "layout.html" %}

{% block title %}NetProbe Pi - Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-network-wired me-2"></i>Network Status
                </h5>
            </div>
            <div class="card-body">
                <div id="network-info">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading network information...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <button id="refresh-network" class="btn btn-sm btn-outline-primary" onclick="console.log('Refresh button clicked directly'); loadNetworkInfo();">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button id="run-ip-info" class="btn btn-sm btn-primary float-end" onclick="console.log('IP Info button clicked directly'); runPlugin('ip_info');">
                    <i class="fas fa-info-circle"></i> Run IP Info
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <button id="run-ping" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="console.log('Ping button clicked directly'); runPlugin('ping_test');">
                        <span><i class="fas fa-exchange-alt me-2"></i>Ping Test</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                    <button id="run-speed" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="console.log('Speed button clicked directly'); runPlugin('speed_test');">
                        <span><i class="fas fa-tachometer-alt me-2"></i>Speed Test</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                    <button id="run-arp" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="console.log('ARP button clicked directly'); runPlugin('arp_scan');">
                        <span><i class="fas fa-sitemap me-2"></i>ARP Scan</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                    <button id="run-port-scan" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="console.log('Port Scan button clicked directly'); runPlugin('port_scan');">
                        <span><i class="fas fa-door-open me-2"></i>Port Scan</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                    <button id="run-traceroute" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="console.log('Traceroute button clicked directly'); runPlugin('traceroute');">
                        <span><i class="fas fa-route me-2"></i>Traceroute</span>
                        <span class="badge bg-primary rounded-pill"><i class="fas fa-play"></i></span>
                    </button>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('plugins') }}" class="btn btn-sm btn-success">
                    <i class="fas fa-plug me-1"></i> All Plugins
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>Recent Results
                </h5>
            </div>
            <div class="card-body">
                <div id="recent-results">
                    <div class="text-center py-4">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading results...</p>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ url_for('results') }}" class="btn btn-sm btn-info text-white">
                    <i class="fas fa-clipboard-list me-1"></i> All Results
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Network Activity
                </h5>
            </div>
            <div class="card-body">
                <div id="network-chart" style="height: 300px;">
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Network activity chart will be displayed here.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-server me-2"></i>System Status
                </h5>
            </div>
            <div class="card-body">
                <div id="system-status">
                    <div class="text-center py-4">
                        <div class="spinner-border text-warning" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading system status...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Plugin Results Section -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header bg-purple text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plug me-2"></i><span id="plugin-result-title">Plugin Results</span>
                </h5>
                <button id="close-results" class="btn btn-sm btn-outline-light" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="card-body">
                <div id="dashboard-result-content">
                    <div class="text-center py-5">
                        <i class="fas fa-plug fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Run a plugin to see results here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // First, ensure jQuery is properly loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Check if jQuery is available
        if (typeof jQuery === 'undefined') {
            console.error('jQuery is not loaded! This will cause plugin buttons to fail.');
            return;
        } else {
            console.log('jQuery is loaded properly:', jQuery.fn.jquery);
        }
        
        // Global function to run plugins
        window.runPlugin = function(pluginName) {
            console.log(`Running plugin: ${pluginName} (global function)`);
            
            // Update the result title and show the close button
            $('#plugin-result-title').text(`${pluginName} Results`);
            $('#close-results').show().off('click').on('click', function() {
                $('#dashboard-result-content').html(`
                    <div class="text-center py-5">
                        <i class="fas fa-plug fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Run a plugin to see results here</p>
                    </div>
                `);
                $('#plugin-result-title').text('Plugin Results');
                $(this).hide();
            });
            
            // Scroll to the results section
            $('html, body').animate({
                scrollTop: $("#dashboard-result-content").offset().top - 70
            }, 500);
            
            // Show loading in the dashboard results area
            $('#dashboard-result-content').html(`
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Running ${pluginName}...</p>
                    <div class="progress mt-3">
                        <div id="plugin-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                            role="progressbar" style="width: 0%" aria-valuenow="0" 
                            aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            `);
            
            // Call API to run plugin
            $.ajax({
                url: `/api/plugin/${pluginName}/run`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({}),
                success: function(data) {
                    console.log(`Plugin ${pluginName} is running:`, data);
                    
                    // Set up socket.io to listen for plugin results
                    const resultEventName = `plugin_result_${pluginName}`;
                    console.log(`Listening for Socket.IO event: ${resultEventName}`);
                    
                    // Remove any previous listeners to avoid duplicates
                    socket.off(resultEventName);
                    
                    // Set up the event listener for this plugin result
                    socket.on(resultEventName, function(result) {
                        console.log(`Received result for ${pluginName}:`, result);
                        
                        // Format and display the result
                        let resultHtml = '';
                        
                        if (result.error) {
                            // Error result
                            resultHtml = `
                                <div class="alert alert-danger">
                                    <h5 class="alert-heading">Error</h5>
                                    <p>${result.error}</p>
                                </div>
                            `;
                        } else if (result.final) {
                            // Final result
                            resultHtml = formatPluginResult(pluginName, result);
                            
                            // After receiving the final result, remove the listener
                            socket.off(resultEventName);
                        } else if (result.progress !== undefined) {
                            // Progress update - just update the progress bar
                            $('#plugin-progress-bar').css('width', `${result.progress}%`).attr('aria-valuenow', result.progress);
                            return; // Don't update the content for progress updates
                        }
                        
                        // Only update the content area for non-progress updates
                        if (resultHtml) {
                            $('#dashboard-result-content').html(resultHtml);
                        }
                    });
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error(`Error running plugin ${pluginName}:`, textStatus, errorThrown);
                    $('#dashboard-result-content').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error running plugin: ${textStatus}
                            <p class="small mt-1 mb-0">${errorThrown}</p>
                        </div>
                    `);
                }
            });
            
            // Setup Socket.IO listener for this specific plugin
            const socket = io();
            console.log(`Setting up Socket.IO listener for plugin_result_${pluginName}`);
            socket.on(`plugin_result_${pluginName}`, function(result) {
                console.log(`Received result for ${pluginName}:`, result);
                
                // Update progress if available
                if (result.progress) {
                    $('#plugin-progress-bar').css('width', `${result.progress}%`).attr('aria-valuenow', result.progress);
                }
                
                // If the result has html content, display it
                if (result.html) {
                    $('#dashboard-result-content').html(result.html);
                } 
                // If the result has a complete status, display the final result
                else if (result.status === 'complete') {
                    let resultHtml = `
                        <div class="result-container">
                            <div class="result-header bg-success text-white p-2 rounded-top">
                                <i class="fas fa-check-circle me-2"></i> ${pluginName} completed successfully
                            </div>
                            <div class="result-body p-3 border border-top-0 rounded-bottom">
                    `;
                    
                    if (result.data) {
                        if (typeof result.data === 'object') {
                            resultHtml += `<pre class="result-code">${JSON.stringify(result.data, null, 2)}</pre>`;
                        } else {
                            resultHtml += `<pre class="result-code">${result.data}</pre>`;
                        }
                    }
                    
                    resultHtml += `
                            </div>
                        </div>
                    `;
                    
                    $('#dashboard-result-content').html(resultHtml);
                }
                // If the result has an error status, display the error
                else if (result.status === 'error') {
                    $('#dashboard-result-content').html(`
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${result.message || 'An error occurred while running the plugin'}
                        </div>
                    `);
                }
            });
        };

        // Initialize Socket.IO
        const socket = io();
        console.log("Initializing Socket.IO connection...");
        
        socket.on('connect', function() {
            console.log('Socket.IO connected!');
        });
        
        socket.on('disconnect', function() {
            console.log('Socket.IO disconnected!');
        });
        
        socket.on('error', function(error) {
            console.error('Socket.IO error:', error);
        });

        // Load initial data
        loadNetworkInfo();
        loadRecentResults();
        loadSystemStatus();

        // Setup event handlers for buttons using jQuery
        $('#refresh-network').on('click', function() {
            console.log("Refresh network button clicked via jQuery");
            loadNetworkInfo();
        });
        
        $('#run-ip-info').on('click', function() {
            console.log("Run IP Info button clicked via jQuery");
            runPlugin('ip_info');
        });
        
        $('#run-ping').on('click', function() {
            console.log("Run Ping Test button clicked via jQuery");
            runPlugin('ping_test');
        });
        
        $('#run-speed').on('click', function() {
            console.log("Run Speed Test button clicked via jQuery");
            runPlugin('speed_test');
        });
        
        $('#run-arp').on('click', function() {
            console.log("Run ARP Scan button clicked via jQuery");
            runPlugin('arp_scan');
        });
        
        $('#run-port-scan').on('click', function() {
            console.log("Run Port Scan button clicked via jQuery");
            runPlugin('port_scan');
        });
        
        $('#run-traceroute').on('click', function() {
            console.log("Run Traceroute button clicked via jQuery");
            runPlugin('traceroute');
        });
        
        // Refresh handlers
        $('#refresh-status').on('click', function() {
            loadSystemStatus();
        });
        
        $('#refresh-results').on('click', function() {
            loadRecentResults();
        });

        // Global event handlers for plugin-related socket events
        socket.on('plugin_result', function(data) {
            console.log('Generic plugin result received:', data);
            // Update the recent results section when a new result is available
            loadRecentResults();
        });
        
        socket.on('plugin_progress', function(data) {
            console.log('Plugin progress update:', data);
            if (data.plugin && data.progress) {
                $(`#plugin-progress-${data.plugin}`).css('width', `${data.progress}%`);
            }
        });
        
        socket.on('network_event', function(data) {
            console.log('Network event received:', data);
            // Show a notification for important network events
            if (data.type === 'device_connected' || data.type === 'device_disconnected') {
                const notificationType = data.type === 'device_connected' ? 'success' : 'warning';
                const icon = data.type === 'device_connected' ? 'plug' : 'unlink';
                
                const notification = `
                    <div class="alert alert-${notificationType} alert-dismissible fade show">
                        <i class="fas fa-${icon} me-2"></i>
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                // Add notification to the top of the page
                $('main.container-fluid').prepend(notification);
                
                // Refresh network info
                loadNetworkInfo();
            }
        });
    });

    // These functions need to be available outside of the jQuery ready function
    function loadNetworkInfo() {
        console.log("Loading network info...");
        $.ajax({
            url: '/api/network/info',
            type: 'GET',
            success: function(data) {
                let html = '';
                
                if (data.interfaces && data.interfaces.length > 0) {
                    html += '<div class="list-group">';
                    data.interfaces.forEach(function(iface) {
                        const isActive = iface.flags && iface.flags.includes('UP');
                        const statusClass = isActive ? 'text-success' : 'text-danger';
                        const statusIcon = isActive ? 'check-circle' : 'times-circle';
                        
                        html += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${iface.name}</h6>
                                    <small class="${statusClass}">
                                        <i class="fas fa-${statusIcon} me-1"></i>
                                        ${isActive ? 'Active' : 'Inactive'}
                                    </small>
                                </div>
                                <div class="text-end">
                        `;
                        
                        if (iface.addresses && iface.addresses.length > 0) {
                            iface.addresses.forEach(function(addr) {
                                if (addr.family === 'inet') {
                                    html += `<div><small class="badge bg-info">${addr.address}</small></div>`;
                                } else if (addr.family === 'inet6') {
                                    html += `<div><small class="badge bg-secondary">${addr.address.substring(0, 10)}...</small></div>`;
                                }
                            });
                        } else {
                            html += `<small class="text-muted">No IP address</small>`;
                        }
                        
                        html += `
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No network interfaces found
                        </div>
                    `;
                }
                
                $('#network-info').html(html);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $('#network-info').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading network information: ${textStatus}
                    </div>
                `);
            }
        });
    }

    function loadRecentResults() {
        console.log("Loading recent results...");
        $.ajax({
            url: '/api/results/recent',
            type: 'GET',
            success: function(data) {
                let html = '';
                
                if (data.results && data.results.length > 0) {
                    html += '<div class="list-group">';
                    data.results.forEach(function(result) {
                        const date = new Date(result.timestamp);
                        const formattedDate = date.toLocaleString();
                        
                        html += `
                            <a href="/results/${result.id}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${result.plugin_name}</h6>
                                    <small>${formattedDate}</small>
                                </div>
                                <small class="text-muted">${result.summary || 'No summary available'}</small>
                            </a>
                        `;
                    });
                    html += '</div>';
                } else {
                    html = `
                        <div class="text-center py-4">
                            <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No recent results found</p>
                            <p class="small text-muted">Run a plugin to see results here</p>
                        </div>
                    `;
                }
                
                $('#recent-results').html(html);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $('#recent-results').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading recent results: ${textStatus}
                    </div>
                `);
            }
        });
    }

    function loadSystemStatus() {
        console.log("Loading system status...");
        $.ajax({
            url: '/api/system/status',
            type: 'GET',
            success: function(data) {
                let html = `
                    <div class="mb-3">
                        <h6>CPU</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                style="width: ${data.cpu_percent}%" 
                                aria-valuenow="${data.cpu_percent}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                                ${data.cpu_percent}%
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Memory</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar" 
                                style="width: ${data.memory_percent}%" 
                                aria-valuenow="${data.memory_percent}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                                ${data.memory_percent}%
                            </div>
                        </div>
                        <small class="text-muted">${data.memory_used}/${data.memory_total} MB</small>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Disk</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                style="width: ${data.disk_percent}%" 
                                aria-valuenow="${data.disk_percent}" 
                                aria-valuemin="0" 
                                aria-valuemax="100">
                                ${data.disk_percent}%
                            </div>
                        </div>
                        <small class="text-muted">${data.disk_used}/${data.disk_total} GB</small>
                    </div>
                    
                    <div>
                        <h6>System Info</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><i class="fas fa-microchip me-2"></i>Hostname</td>
                                <td>${data.hostname}</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-clock me-2"></i>Uptime</td>
                                <td>${data.uptime}</td>
                            </tr>
                            <tr>
                                <td><i class="fas fa-thermometer-half me-2"></i>Temperature</td>
                                <td>${data.temperature}°C</td>
                            </tr>
                        </table>
                    </div>
                `;
                
                $('#system-status').html(html);
            },
            error: function(jqXHR, textStatus, errorThrown) {
                $('#system-status').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading system status: ${textStatus}
                    </div>
                `);
            }
        });
    }
    
    // Helper function to format plugin results based on plugin type
    function formatPluginResult(pluginName, result) {
        console.log(`Formatting result for ${pluginName}:`, result);
        
        // Default formatting
        let html = `
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">Result</h5>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 rounded">${JSON.stringify(result, null, 2)}</pre>
                </div>
            </div>
        `;
        
        // Plugin-specific formatting
        switch(pluginName) {
            case 'ping_test':
                if (result.ping_results) {
                    html = formatPingTestResult(result);
                }
                break;
            case 'port_scan':
                if (result.open_ports) {
                    html = formatPortScanResult(result);
                }
                break;
            case 'arp_scan':
                if (result.hosts) {
                    html = formatArpScanResult(result);
                }
                break;
            case 'ip_info':
                if (result.ip_info) {
                    html = formatIpInfoResult(result);
                }
                break;
            case 'speed_test':
                if (result.download || result.upload) {
                    html = formatSpeedTestResult(result);
                }
                break;
            case 'traceroute':
                if (result.hops) {
                    html = formatTracerouteResult(result);
                }
                break;
        }
        
        return html;
    }
    
    // Format ping test results
    function formatPingTestResult(result) {
        const pingResults = result.ping_results || {};
        const successful = pingResults.successful || 0;
        const failed = pingResults.failed || 0;
        const total = successful + failed;
        const successRate = total > 0 ? Math.round((successful / total) * 100) : 0;
        
        let html = `
            <div class="card mb-3">
                <div class="card-header ${successRate > 80 ? 'bg-success' : (successRate > 50 ? 'bg-warning' : 'bg-danger')} text-white">
                    <h5 class="card-title mb-0">Ping Test Results</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h1 class="display-4 ${successRate > 80 ? 'text-success' : (successRate > 50 ? 'text-warning' : 'text-danger')}">${successRate}%</h1>
                                    <p class="lead">Success Rate</p>
                                    <div class="d-flex justify-content-between mt-3">
                                        <div>
                                            <h5 class="text-success">${successful}</h5>
                                            <p>Successful</p>
                                        </div>
                                        <div>
                                            <h5 class="text-danger">${failed}</h5>
                                            <p>Failed</p>
                                        </div>
                                        <div>
                                            <h5>${total}</h5>
                                            <p>Total</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Statistics</h5>
                                    <table class="table">
                                        <tr>
                                            <th>Target</th>
                                            <td>${result.target || 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Min Latency</th>
                                            <td>${pingResults.min_latency ? pingResults.min_latency.toFixed(2) + ' ms' : 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Max Latency</th>
                                            <td>${pingResults.max_latency ? pingResults.max_latency.toFixed(2) + ' ms' : 'N/A'}</td>
                                        </tr>
                                        <tr>
                                            <th>Avg Latency</th>
                                            <td>${pingResults.avg_latency ? pingResults.avg_latency.toFixed(2) + ' ms' : 'N/A'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h5>Raw Output</h5>
                        <pre class="bg-light p-3 rounded small">${pingResults.raw_output || 'No raw output available'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }
    
    // Format port scan results
    function formatPortScanResult(result) {
        const openPorts = result.open_ports || {};
        const target = result.target || 'Unknown';
        
        let html = `
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Port Scan Results</h5>
                </div>
                <div class="card-body">
                    <h5>Target: ${target}</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Port</th>
                                    <th>Protocol</th>
                                    <th>State</th>
                                    <th>Service</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        if (Object.keys(openPorts).length > 0) {
            for (const [port, info] of Object.entries(openPorts)) {
                html += `
                    <tr>
                        <td>${port}</td>
                        <td>${info.protocol || 'tcp'}</td>
                        <td>${info.state || 'open'}</td>
                        <td>${info.service || 'unknown'}</td>
                    </tr>
                `;
            }
        } else {
            html += `
                <tr>
                    <td colspan="4" class="text-center">No open ports found</td>
                </tr>
            `;
        }
        
        html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <h5>Raw Output</h5>
                        <pre class="bg-light p-3 rounded small">${result.raw_output || 'No raw output available'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }
    
    // Format ARP scan results
    function formatArpScanResult(result) {
        const hosts = result.hosts || [];
        
        let html = `
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">ARP Scan Results</h5>
                </div>
                <div class="card-body">
                    <h5>Discovered Hosts: ${hosts.length}</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>IP Address</th>
                                    <th>MAC Address</th>
                                    <th>Vendor</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        if (hosts.length > 0) {
            hosts.forEach(host => {
                html += `
                    <tr>
                        <td>${host.ip || 'N/A'}</td>
                        <td>${host.mac || 'N/A'}</td>
                        <td>${host.vendor || 'Unknown'}</td>
                    </tr>
                `;
            });
        } else {
            html += `
                <tr>
                    <td colspan="3" class="text-center">No hosts found</td>
                </tr>
            `;
        }
        
        html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <h5>Raw Output</h5>
                        <pre class="bg-light p-3 rounded small">${result.raw_output || 'No raw output available'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }
    
    // Format IP info results
    function formatIpInfoResult(result) {
        const ipInfo = result.ip_info || {};
        
        let html = `
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">IP Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Public IP</div>
                                <div class="card-body">
                                    <h3>${ipInfo.public_ip || 'Unknown'}</h3>
                                    ${ipInfo.isp ? `<p class="mb-0 text-muted">ISP: ${ipInfo.isp}</p>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">Geolocation</div>
                                <div class="card-body">
                                    <h5>${ipInfo.country || 'Unknown'}</h5>
                                    <p class="mb-0">${ipInfo.city ? ipInfo.city + ', ' : ''}${ipInfo.region || ''}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header">Local Network</div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Interface</th>
                                            <th>IP Address</th>
                                            <th>MAC Address</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;
        
        if (ipInfo.interfaces && Object.keys(ipInfo.interfaces).length > 0) {
            for (const [name, info] of Object.entries(ipInfo.interfaces)) {
                html += `
                    <tr>
                        <td>${name}</td>
                        <td>${info.ip || 'N/A'}</td>
                        <td>${info.mac || 'N/A'}</td>
                    </tr>
                `;
            }
        } else {
            html += `
                <tr>
                    <td colspan="3" class="text-center">No interfaces found</td>
                </tr>
            `;
        }
        
        html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }
    
    // Format speed test results
    function formatSpeedTestResult(result) {
        const download = result.download || 0;
        const upload = result.upload || 0;
        const ping = result.ping || 0;
        
        let html = `
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Speed Test Results</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h2 class="text-primary">${(download / 1000000).toFixed(2)} Mbps</h2>
                                    <p class="lead">Download</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h2 class="text-success">${(upload / 1000000).toFixed(2)} Mbps</h2>
                                    <p class="lead">Upload</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h2 class="text-info">${ping.toFixed(2)} ms</h2>
                                    <p class="lead">Ping</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <tr>
                                <th>Server</th>
                                <td>${result.server_name || 'Unknown'}</td>
                            </tr>
                            <tr>
                                <th>Server Country</th>
                                <td>${result.server_country || 'Unknown'}</td>
                            </tr>
                            <tr>
                                <th>Test Time</th>
                                <td>${result.timestamp ? new Date(result.timestamp).toLocaleString() : 'Unknown'}</td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }
    
    // Format traceroute results
    function formatTracerouteResult(result) {
        const hops = result.hops || [];
        const target = result.target || 'Unknown';
        
        let html = `
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Traceroute Results</h5>
                </div>
                <div class="card-body">
                    <h5>Target: ${target}</h5>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Hop</th>
                                    <th>IP Address</th>
                                    <th>Hostname</th>
                                    <th>Latency (ms)</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        if (hops.length > 0) {
            hops.forEach((hop, index) => {
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${hop.ip || '*'}</td>
                        <td>${hop.hostname || 'Unknown'}</td>
                        <td>${hop.latency ? hop.latency.toFixed(2) : '*'}</td>
                    </tr>
                `;
            });
        } else {
            html += `
                <tr>
                    <td colspan="4" class="text-center">No hops found</td>
                </tr>
            `;
        }
        
        html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <h5>Raw Output</h5>
                        <pre class="bg-light p-3 rounded small">${result.raw_output || 'No raw output available'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }
</script>
{% endblock %}
