<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Information - NetScout Pi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">NetScout Pi</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/system/stats">System</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>System Information</h5>
                        <div class="badge bg-success" id="update-status">Live</div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <th>Hostname</th>
                                            <td id="system-hostname">-</td>
                                        </tr>
                                        <tr>
                                            <th>Platform</th>
                                            <td id="system-platform">-</td>
                                        </tr>
                                        <tr>
                                            <th>Uptime</th>
                                            <td id="system-uptime">-</td>
                                        </tr>
                                        <tr>
                                            <th>CPU</th>
                                            <td id="system-cpu">-</td>
                                        </tr>
                                        <tr>
                                            <th>CPU Temperature</th>
                                            <td id="system-temp">-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Memory Usage</label>
                                    <div class="progress">
                                        <div id="memory-progress" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                    <div class="small text-muted mt-1" id="memory-text">- / -</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Disk Usage</label>
                                    <div class="progress">
                                        <div id="disk-progress" class="progress-bar" role="progressbar" style="width: 0%">0%</div>
                                    </div>
                                    <div class="small text-muted mt-1" id="disk-text">- / -</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Network Interfaces</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Interface</th>
                                        <th>IP Address</th>
                                        <th>Netmask</th>
                                        <th>Received</th>
                                        <th>Sent</th>
                                    </tr>
                                </thead>
                                <tbody id="network-interfaces">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>CPU Usage</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="cpu-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Network Traffic</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="network-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Socket.IO connection
        const socket = io();
        
        // Charts
        let cpuChart;
        let networkChart;
        
        // Data for charts
        const cpuData = {
            labels: [],
            datasets: [{
                label: 'CPU Usage (%)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,
                fill: false
            }]
        };
        
        const networkData = {
            labels: [],
            datasets: [
                {
                    label: 'Received (KB/s)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'Sent (KB/s)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1,
                    fill: false
                }
            ]
        };
        
        // Previous network values for calculating deltas
        let prevNetwork = {};
        let prevTimestamp = null;
        
        // Initialize charts on document load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            
            // Socket events
            socket.on('connect', () => {
                document.getElementById('update-status').textContent = 'Live';
                document.getElementById('update-status').className = 'badge bg-success';
            });
            
            socket.on('disconnect', () => {
                document.getElementById('update-status').textContent = 'Offline';
                document.getElementById('update-status').className = 'badge bg-danger';
            });
            
            socket.on('system_update', (data) => {
                updateSystemInfo(data);
                updateCharts(data);
            });
        });
        
        // Initialize charts
        function initCharts() {
            const cpuCtx = document.getElementById('cpu-chart').getContext('2d');
            cpuChart = new Chart(cpuCtx, {
                type: 'line',
                data: cpuData,
                options: {
                    animation: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
            
            const networkCtx = document.getElementById('network-chart').getContext('2d');
            networkChart = new Chart(networkCtx, {
                type: 'line',
                data: networkData,
                options: {
                    animation: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });
        }
        
        // Update system information
        function updateSystemInfo(data) {
            const system = data.system;
            const network = data.network;
            
            // Basic system info
            document.getElementById('system-hostname').textContent = system.hostname;
            document.getElementById('system-platform').textContent = system.platform;
            
            // Format uptime as days, hours, minutes
            const uptime = Math.floor((Date.now() / 1000) - system.uptime);
            const days = Math.floor(uptime / 86400);
            const hours = Math.floor((uptime % 86400) / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            document.getElementById('system-uptime').textContent = 
                `${days}d ${hours}h ${minutes}m`;
            
            // CPU info
            document.getElementById('system-cpu').textContent = 
                `${system.cpu_usage}% (${system.cpu_count} cores)`;
            
            // CPU temperature
            if (system.cpu_temperature !== null) {
                document.getElementById('system-temp').textContent = 
                    `${system.cpu_temperature.toFixed(1)}Â°C`;
            } else {
                document.getElementById('system-temp').textContent = 'N/A';
            }
            
            // Memory usage
            const memoryPercent = system.memory_percent;
            const memoryUsed = formatBytes(system.memory_used);
            const memoryTotal = formatBytes(system.memory_total);
            
            document.getElementById('memory-progress').style.width = `${memoryPercent}%`;
            document.getElementById('memory-progress').textContent = `${memoryPercent}%`;
            document.getElementById('memory-text').textContent = `${memoryUsed} / ${memoryTotal}`;
            
            // Set color based on usage
            if (memoryPercent > 80) {
                document.getElementById('memory-progress').className = 'progress-bar bg-danger';
            } else if (memoryPercent > 60) {
                document.getElementById('memory-progress').className = 'progress-bar bg-warning';
            } else {
                document.getElementById('memory-progress').className = 'progress-bar bg-success';
            }
            
            // Disk usage
            const diskPercent = system.disk_percent;
            const diskUsed = formatBytes(system.disk_used);
            const diskTotal = formatBytes(system.disk_total);
            
            document.getElementById('disk-progress').style.width = `${diskPercent}%`;
            document.getElementById('disk-progress').textContent = `${diskPercent}%`;
            document.getElementById('disk-text').textContent = `${diskUsed} / ${diskTotal}`;
            
            // Set color based on usage
            if (diskPercent > 80) {
                document.getElementById('disk-progress').className = 'progress-bar bg-danger';
            } else if (diskPercent > 60) {
                document.getElementById('disk-progress').className = 'progress-bar bg-warning';
            } else {
                document.getElementById('disk-progress').className = 'progress-bar bg-success';
            }
            
            // Network interfaces
            const networkInterfaces = document.getElementById('network-interfaces');
            networkInterfaces.innerHTML = '';
            
            // Get network interfaces from system.network
            Object.entries(system.network).forEach(([name, info]) => {
                const row = document.createElement('tr');
                
                // Get network stats
                const stats = network[name] || {};
                const bytesRecv = formatBytes(stats.bytes_recv || 0);
                const bytesSent = formatBytes(stats.bytes_sent || 0);
                
                row.innerHTML = `
                    <td>${name}</td>
                    <td>${info.ip || 'N/A'}</td>
                    <td>${info.netmask || 'N/A'}</td>
                    <td>${bytesRecv}</td>
                    <td>${bytesSent}</td>
                `;
                
                networkInterfaces.appendChild(row);
            });
        }
        
        // Update charts with new data
        function updateCharts(data) {
            const timestamp = new Date(data.timestamp * 1000).toLocaleTimeString();
            const system = data.system;
            const network = data.network;
            
            // Update CPU chart
            if (cpuData.labels.length > 20) {
                cpuData.labels.shift();
                cpuData.datasets[0].data.shift();
            }
            
            cpuData.labels.push(timestamp);
            cpuData.datasets[0].data.push(system.cpu_usage);
            cpuChart.update();
            
            // Update Network chart - calculate deltas
            if (prevTimestamp !== null) {
                const timeDelta = data.timestamp - prevTimestamp;
                let primaryInterface = null;
                
                // Find the primary interface (first one with an IP)
                for (const [name, info] of Object.entries(system.network)) {
                    if (info.ip) {
                        primaryInterface = name;
                        break;
                    }
                }
                
                if (primaryInterface && network[primaryInterface] && prevNetwork[primaryInterface]) {
                    const curRecv = network[primaryInterface].bytes_recv || 0;
                    const curSent = network[primaryInterface].bytes_sent || 0;
                    const prevRecv = prevNetwork[primaryInterface].bytes_recv || 0;
                    const prevSent = prevNetwork[primaryInterface].bytes_sent || 0;
                    
                    // Calculate KB/s
                    const recvRate = (curRecv - prevRecv) / timeDelta / 1024;
                    const sentRate = (curSent - prevSent) / timeDelta / 1024;
                    
                    if (networkData.labels.length > 20) {
                        networkData.labels.shift();
                        networkData.datasets[0].data.shift();
                        networkData.datasets[1].data.shift();
                    }
                    
                    networkData.labels.push(timestamp);
                    networkData.datasets[0].data.push(recvRate);
                    networkData.datasets[1].data.push(sentRate);
                }
            }
            
            // Update previous values
            prevNetwork = JSON.parse(JSON.stringify(network));
            prevTimestamp = data.timestamp;
            
            networkChart.update();
        }
        
        // Format bytes to human-readable format
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
