<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Scanner UI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .network-map {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: auto;
            position: relative;
        }
        .device-node {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #f8f9fa;
            border: 2px solid #6c757d;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .device-node:hover {
            transform: scale(1.1);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .device-node.router {
            border-color: #007bff;
        }
        .device-node.device {
            border-color: #28a745;
        }
        .device-link {
            position: absolute;
            background-color: #e9ecef;
            z-index: -1;
        }
        .device-icon {
            font-size: 1.5rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <h2>Network Map</h2>
        <p>This visualization shows the devices found on your network. Click on a device to see more details.</p>
        
        <div class="network-map" id="network-map">
            <!-- Network visualization will be rendered here -->
            <div class="text-center p-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">Run a scan to visualize your network</p>
            </div>
        </div>
        
        <div class="mt-4">
            <div class="card">
                <div class="card-header">
                    <h5>Device Details</h5>
                </div>
                <div class="card-body" id="device-details">
                    <p class="text-muted text-center">Select a device to view details</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // This script will be executed in the plugin UI iframe
        
        // Listen for messages from parent window
        window.addEventListener('message', function(event) {
            // Handle scan results
            if (event.data && event.data.type === 'scan_results') {
                renderNetworkMap(event.data.data);
            }
        });
        
        // Function to render network map
        function renderNetworkMap(devices) {
            const mapContainer = document.getElementById('network-map');
            mapContainer.innerHTML = '';
            
            if (!devices || devices.length === 0) {
                mapContainer.innerHTML = '<p class="text-center p-5">No devices found in the scan. Try scanning again.</p>';
                return;
            }
            
            // Get the gateway device (usually first IP in subnet)
            const gateway = devices.find(device => device[0].endsWith('.1')) || devices[0];
            
            // Create gateway node
            const gatewayNode = document.createElement('div');
            gatewayNode.className = 'device-node router';
            gatewayNode.style.left = '50%';
            gatewayNode.style.top = '50px';
            gatewayNode.style.transform = 'translateX(-50%)';
            gatewayNode.innerHTML = '<div class="device-icon">üåê</div>';
            gatewayNode.setAttribute('data-ip', gateway[0]);
            gatewayNode.setAttribute('data-hostname', gateway[1]);
            gatewayNode.setAttribute('data-mac', gateway[2]);
            mapContainer.appendChild(gatewayNode);
            
            // Create other device nodes in a circle around the gateway
            const centerX = mapContainer.offsetWidth / 2;
            const centerY = mapContainer.offsetHeight / 2;
            const radius = Math.min(centerX, centerY) - 100;
            
            devices.forEach((device, index) => {
                if (device[0] === gateway[0]) return; // Skip gateway
                
                const angle = (2 * Math.PI * index) / devices.length;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                
                const deviceNode = document.createElement('div');
                deviceNode.className = 'device-node device';
                deviceNode.style.left = `${x}px`;
                deviceNode.style.top = `${y}px`;
                deviceNode.style.transform = 'translate(-50%, -50%)';
                deviceNode.innerHTML = '<div class="device-icon">üíª</div>';
                deviceNode.setAttribute('data-ip', device[0]);
                deviceNode.setAttribute('data-hostname', device[1]);
                deviceNode.setAttribute('data-mac', device[2]);
                mapContainer.appendChild(deviceNode);
                
                // Create link to gateway
                createLink(mapContainer, 
                    parseInt(gatewayNode.style.left) + 30, 
                    parseInt(gatewayNode.style.top) + 30,
                    x, y);
            });
            
            // Add click event listeners
            const deviceNodes = document.querySelectorAll('.device-node');
            deviceNodes.forEach(node => {
                node.addEventListener('click', function() {
                    showDeviceDetails(
                        this.getAttribute('data-ip'),
                        this.getAttribute('data-hostname'),
                        this.getAttribute('data-mac')
                    );
                });
            });
        }
        
        // Function to create a visual link between two points
        function createLink(container, x1, y1, x2, y2) {
            const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
            
            const link = document.createElement('div');
            link.className = 'device-link';
            link.style.width = `${length}px`;
            link.style.height = '2px';
            link.style.left = `${x1}px`;
            link.style.top = `${y1}px`;
            link.style.transform = `rotate(${angle}deg)`;
            link.style.transformOrigin = '0 0';
            
            container.appendChild(link);
        }
        
        // Function to show device details
        function showDeviceDetails(ip, hostname, mac) {
            const detailsContainer = document.getElementById('device-details');
            
            detailsContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="device-icon" style="font-size: 3rem">üíª</div>
                        <h5 class="mt-2">${hostname !== 'Unknown' ? hostname : ip}</h5>
                    </div>
                    <div class="col-md-8">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th>IP Address:</th>
                                    <td>${ip}</td>
                                </tr>
                                <tr>
                                    <th>Hostname:</th>
                                    <td>${hostname}</td>
                                </tr>
                                <tr>
                                    <th>MAC Address:</th>
                                    <td>${mac}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
